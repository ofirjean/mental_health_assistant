pipeline {
  agent {
    kubernetes {
      label 'k8s-yaml'
      defaultContainer 'builder'
      idleMinutes 0
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels: { jenkins: agent }
spec:
  serviceAccountName: jenkins
  volumes:
    - name: workspace
      emptyDir: {}
    - name: docker-graph
      emptyDir: {}
  containers:
    - name: jnlp
      image: jenkins/inbound-agent:latest-jdk17   # Docker Hub (pulls fine)
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent

    - name: builder
      image: python:3.11-alpine
      command: ['sh','-c','cat']
      tty: true
      env:
        - name: DOCKER_HOST
          value: tcp://localhost:2375
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent

    - name: dind
      image: docker:27-dind
      imagePullPolicy: IfNotPresent
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
      args:
        - --host=tcp://0.0.0.0:2375
        - --storage-driver=overlay2
      volumeMounts:
        - name: docker-graph
          mountPath: /var/lib/docker
"""
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '20'))
    overrideIndexTriggers(true)
  }

  triggers { pollSCM('H/2 * * * *') }

  parameters {
    string(name: 'FORCE_TAG', defaultValue: '', description: 'Override image tag; leave empty to auto-generate on main')
  }

  environment {
    DOCKER_REPO     = 'ofirjean/mental-health-assistant'
    VALUES_FILE     = 'app/helm/values-prod.yaml'
    CRED_DOCKERHUB  = 'DockerHub'
    CRED_GITHUB_PAT = 'github-pat'
    CRED_GITLAB_PAT = 'gitlab-pat'
  }

  stages {
    stage('Checkout'){
      steps {
        checkout scm
        // Ensure git exists in the default (builder) container BEFORE using it
        sh '''
          set -euo pipefail
          if ! command -v git >/dev/null 2>&1; then
            apk add --no-cache git
          fi
          git config --global --add safe.directory "$PWD"
          git status -sb || true
        '''
      }
    }

    // Install docker CLI and wait for DinD
    stage('Install tools') {
      steps {
        sh '''
          set -euo pipefail
          if ! command -v docker >/dev/null 2>&1; then
            apk add --no-cache docker-cli curl
          fi
          for i in $(seq 1 30); do
            if docker version >/dev/null 2>&1; then break; fi
            echo "Waiting for Docker daemon (attempt $i/30)..."; sleep 2
          done
          python --version
          docker version || true
        '''
      }
    }

    stage('Sanity checks') {
      steps {
        sh '''
          set -euo pipefail
          echo "Branch: ${BRANCH_NAME}"
          echo "Workspace: $PWD"
          ls -la

          command -v docker || true
          docker version || { echo "Docker not ready yet (will try later)"; true; }

          test -f "$VALUES_FILE" || { echo "Missing $VALUES_FILE"; exit 3; }

          git --version
          git remote -v
        '''
      }
    }

    stage('Set Tag'){
      when { branch 'main' }
      steps {
        script {
          env.TAG = params.FORCE_TAG?.trim() ? params.FORCE_TAG.trim() : "v0.1.${env.BUILD_NUMBER}"
        }
        echo "Using TAG=${env.TAG}"
      }
    }

    stage('Build & Push Image'){
      when { branch 'main' }
      steps {
        echo "Using Docker Hub credential ID: ${CRED_DOCKERHUB}"
        withCredentials([usernamePassword(credentialsId: env.CRED_DOCKERHUB, usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
          sh '''
            set -euo pipefail
            echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
            docker build -t "$DOCKER_REPO:$TAG" app
            docker push  "$DOCKER_REPO:$TAG"
            docker logout || true
          '''
        }
      }
    }

    stage('Bump Helm image.tag'){
      when { branch 'main' }
      steps {
        sh '''
          set -euo pipefail
          if command -v yq >/dev/null 2>&1; then
            yq -i '.image.tag = env(TAG)' "$VALUES_FILE"
          else
            awk -v tag="$TAG" '
              BEGIN{in_image=0}
              /^[[:space:]]*image:[[:space:]]*$/ {in_image=1; print; next}
              /^[^[:space:]]/ {in_image=0}
              in_image && /^[[:space:]]*tag:[[:space:]]*/ { sub(/tag:.*/, "tag: " tag); print; next }
              {print}
            ' "$VALUES_FILE" > "$VALUES_FILE.tmp" && mv "$VALUES_FILE.tmp" "$VALUES_FILE"
          fi
          echo "==== values snippet ===="
          grep -nE '^[[:space:]]*image:|^[[:space:]]*tag:' "$VALUES_FILE" | sed -n '1,120p'
        '''
      }
    }

    stage('Commit & Push to GitHub (PAT)'){
      when { branch 'main' }
      steps {
        withCredentials([usernamePassword(credentialsId: env.CRED_GITHUB_PAT, usernameVariable: 'GH_USER', passwordVariable: 'GH_PAT')]) {
          sh '''
            set -euo pipefail
            git config user.name  "Jenkins CI"
            git config user.email "ci@local"
            git add "$VALUES_FILE"
            git commit -m "ci: bump image tag to $TAG" || true

            git remote set-url origin "https://${GH_USER}:${GH_PAT}@github.com/ofirjean/mental_health_assistant"
            BRANCH="${BRANCH_NAME}"
            git push origin "HEAD:${BRANCH}"

            git tag -f "$TAG" || true
            git push origin --force "refs/tags/$TAG"
          '''
        }
      }
    }

    stage('Mirror to GitLab (PAT)'){
      when { branch 'main' }
      steps {
        withCredentials([usernamePassword(credentialsId: env.CRED_GITLAB_PAT, usernameVariable: 'GL_USER', passwordVariable: 'GL_PAT')]) {
          sh '''
            set -euo pipefail
            git remote remove gitlab 2>/dev/null || true
            git remote add    gitlab "https://${GL_USER}:${GL_PAT}@gitlab.com/sela-tracks/1116/students/ofir/final-project"
            BRANCH="${BRANCH_NAME}"
            git push gitlab "HEAD:${BRANCH}"
            git push gitlab "refs/tags/$TAG"
          '''
        }
      }
    }
  }

  post {
    success { echo "Built & pushed ${env.DOCKER_REPO}:${env.TAG}" }
    failure { echo "Build failed on branch ${env.BRANCH_NAME ?: 'n/a'}." }
    always  {
      script {
        // If the agent never started, there may be no workspace; don't fail cleanup
        try { cleanWs deleteDirs: true, notFailBuild: true } catch (err) { echo "Skipping cleanWs: ${err}" }
      }
    }
  }
}
