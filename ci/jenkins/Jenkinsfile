pipeline {
  agent {
    kubernetes {
      yamlFile 'ci/jenkins/build-agents.yaml'
      defaultContainer 'builder'
    }
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials('DockerHub')
    DISCORD_WEBHOOK       = credentials('discord-webhook')
    DOCKERHUB_REPO        = 'ofirjean/mental_health_assistant'
    HELM_RELEASE          = 'mha-release'
    NAMESPACE             = 'mental-health'
  }

  stages {

    stage('Checkout') {
      steps {
        container('builder') {
          checkout scm
          sh '''
            set -e
            echo "Branch: ${BRANCH_NAME:-unknown}"
            echo "Commit: ${GIT_COMMIT:-unknown}"
            ls -la
          '''
        }
      }
    }

    stage('Unit Tests') {
      steps {
        container('builder') {
          sh '''
            set -e
            python3 --version
            pip3 install --upgrade pip
            pip3 install -r app/requirements.txt pytest
            PYTHONPATH=. pytest app/tests/test_sample.py -v --maxfail=1 --disable-warnings
          '''
        }
      }
    }

    stage('Helm Lint & Template') {
      steps {
        container('builder') {
          sh '''
            set -e
            helm version
            helm lint app/helm/
            helm template ${HELM_RELEASE} app/helm/ --namespace ${NAMESPACE}
          '''
        }
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        container('builder') {
          withCredentials([usernamePassword(credentialsId: 'DockerHub', usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
            sh '''
              set -e
              docker --version
              docker build -t ${DH_USER}/mental_health_assistant:${BUILD_NUMBER} -f app/Dockerfile .
              docker tag ${DH_USER}/mental_health_assistant:${BUILD_NUMBER} ${DH_USER}/mental_health_assistant:latest
              echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
              docker push ${DH_USER}/mental_health_assistant:${BUILD_NUMBER}
              docker push ${DH_USER}/mental_health_assistant:latest
            '''
          }
        }
      }
    }

    stage('Helm Package & Push (main only)') {
      when { branch 'main' }
      steps {
        container('builder') {
          withCredentials([usernamePassword(credentialsId: 'DockerHub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
            sh '''
              set -e
              helm package app/helm/ -d .
              helm registry login registry-1.docker.io \
                --username "$USER" \
                --password "$PASS"
              CHART_TGZ=$(ls ./*.tgz | head -n1)
              helm push "$CHART_TGZ" oci://registry-1.docker.io/$USER
            '''
          }
        }
      }
    }

    stage('Deploy with Helm (main only)') {
      when { branch 'main' }
      steps {
        container('builder') {
          sh '''
            set -e
            helm upgrade --install ${HELM_RELEASE} app/helm/ \
              --set image.repository=${DOCKERHUB_REPO} \
              --set image.tag=${BUILD_NUMBER} \
              --namespace ${NAMESPACE} \
              --create-namespace \
              --atomic --cleanup-on-fail
          '''
        }
      }
    }

    stage('Verify Deployment (main only)') {
      when { branch 'main' }
      steps {
        container('builder') {
          sh '''
            set -e
            kubectl -n ${NAMESPACE} rollout status deployment/flask-app --timeout=90s
            kubectl -n ${NAMESPACE} get pods
            kubectl -n ${NAMESPACE} get svc
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ Pipeline succeeded!"
    }

    failure {
      echo "❌ Pipeline failed!"
      script {
        if (env.DISCORD_WEBHOOK) {
          def message = [
            content: "❌ Pipeline FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${env.BUILD_URL}"
          ]
          httpRequest acceptType: 'APPLICATION_JSON',
                      contentType: 'APPLICATION_JSON',
                      httpMode: 'POST',
                      requestBody: groovy.json.JsonOutput.toJson(message),
                      url: env.DISCORD_WEBHOOK,
                      validResponseCodes: '200:204'
        }
      }
      emailext(
        to: 'ofirjean11@gmail.com',
        subject: "❌ Jenkins Pipeline FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        body: """<p>The pipeline failed.</p>
                 <p>Job: ${env.JOB_NAME}<br/>
                 Build: <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></p>"""
      )
    }
  }
}
